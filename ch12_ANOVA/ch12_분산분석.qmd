---
title: "ch12_분산분석"
format: html
toc: true
toc-depth: 5
---

```{r setup, include=FALSE}
library(ggpubr)
library(DescTools)
```

## 분산분석, 분산분석표, 분산분석 모형

### 예제2

![](./images/1.png)

```{r}
#| label: 예제1에 맞는 난수 발생(평균 70,80,90, 공통분산 25)

set.seed(12)
Grp1 = rnorm(5,70,5)
Grp2 = rnorm(5,80,5)
Grp3 = rnorm(5,90,5)
df1 = data.frame(Grp1,Grp2,Grp3)
df1 = signif(df1,3)
df1
```
```{r}
#| label: 분산분석 데이터 구조 만들기 - 각 그룹의 평균 및 전체 평균 계산

signif(mean(Grp1),4) # 각 그룹의 평균
signif(mean(Grp2),4)
signif(mean(Grp3),4)
signif((mean(Grp1)+mean(Grp2)+mean(Grp3))/3,4) # 전체 평균
```

#### 분산분석 데이터 구조 - 예제2

| 반복수 | 그룹1 | 그룹2 | 그룹3 |        |
|---------|----- |------ |------ |--------|
| 1       | 62.6 |  78.6 | 86.1  |        |
| 2       | 77.9 |  78.4 | 83.5  |        |
| 3       | 65.2 |  76.9 | 86.1  |        |
| 4       | 65.4 |  79.5 | 90.1  |        |
| 5       | 60.0 |  82.1 | 89.2  |전체평균|
| 평균    | 66.22|  79.11| 87.01 |77.45   |


#### 분산분석을 하려면 tidy data로!

```{r}
#| label : tidy data로 변경(2차원 행렬의 데이터 구조를 1차원 형태의 데이터 구조로 변환)

df2 = stack(df1)
df2
```

#### ggpubr 패키지를 활용한 점도표

```{r}
ggline(df2, x = "ind", y = "values", add = c("mean_sd", "jitter"), title = "Data in ANOVA model", ylab ="", xlab = "")
```

jitter는 점이 겹치지 않도록 양 옆으로 점을 분산시킨다.

아래는 jitter 옵션이 적용되지 않은 그래프

```{r}
ggline(df2, x = "ind", y = "values", add = c("mean_sd"), title = "Data in ANOVA model", ylab ="", xlab = "")
```
		
mean_sd 옵션은 평균과 표준편차를 표시하고 평균을 선으로 연결한다.

아래는 mean_sd 옵션을 제외한 그래프(모든 add 옵션 없음)

```{r}
ggline(df2, x = "ind", y = "values", title = "Data in ANOVA model", ylab ="", xlab = "")
```

jitter만 적용시킨 그래프는 아래와 같다.

```{r}
ggline(df2, x = "ind", y = "values", add = "jitter", title = "Data in ANOVA model", ylab ="", xlab = "")
```

## 일원배치 분산분석

one-way ANOVA는 완전랜덤화 실험설계(CRD: Complete Randomized Design)를 가정한다.

### 예제3

![](./images/2.png)

#### 완전랜덤화 실험

```{r}
set.seed(12)
x = 1:20
x1 = sample(x,5) # 1에서 20까지의 숫자중 5개의 표본을 무작위로 뽑는다.
x1
```

```{r}
set.seed(12)
x2 = sample(x[-x1],5) # 1에서 20까지의 숫자중 x1을 제외한 5개의 표본을 무작위로 뽑는다.
x2
```

```{r}
set.seed(12)
x3 = sample(x[-c(x1,x2)],5) # 1에서 20까지의 숫자중 x1, x2를 제외한 5개의 표본을 무작위로 뽑는다.
x3
```

```{r}
set.seed(12)
x4 = sample(x[-c(x1,x2,x3)],5) # 1에서 20까지의 숫자중 x1, x2, x3를 제외한 5개의 표본을 무작위로 뽑는다.
x4
```

### 예제 4

![](./images/3.png)

#### 분산분석표 anova() + aov()

```{r}
Group = rep(c("Seoul","Busan","Gwangju"), each = 3)
X = c(550,600,650,520,570,620,500,580,540)
OneWay = aov(X ~ Group) # aov()로 분산분석 실행 및 결과를 OneWay 객체에 저장, 일원 배치 분산분석이므로 독립변수 1개.
anova(OneWay) #anova()로 분산분석표 요청
```

#### 분산분석 모형의 모수에 대한 추정값

##### 수준별 평균모형
$$X_{ij}=\mu_j+\epsilon_{ij}$$

```{r}
aggregate(X, by = list(Group), mean) # 수준별 평균모형(첫번째 형태의 분산분석 모형)
```

by 옵션은 list 값을 요구하기 때문에, Group을 리스트로 만들어 준다.
위 코드를 말로 표현하자면, 'X의 값을 Group별로 평균한다.' 로 표현할 수 있다.

##### 효과 모형
$$X_{ij} = \mu + \tau_j + \epsilon_{ij}$$

```{r}
model.tables(OneWay) # 효과모형
```

$\mu$에 대한 추정량은 제공되지 않는다. 그러나 각 그룹의 $\tau_j$의 추정량은 제공된다.
그러므로 $\mu$에 대한 추정량이 570임을 알 수 있다.(Busan의 $\tau_j$가 0 이므로 $\mu$ = Busan 그룹의 평균)

##### 레퍼런스 그룹이 있는 효과 모형
$$X_{ij} = \mu_1 + \tau_j + \epsilon_{ij}$$

```{r}
OneWay$coefficients
```

여기서 레퍼런스그룹은 알파벳, 가나다 순으로 첫번째 수준이 레퍼런스 그룹이 된다. 항상 레퍼런스 그룹을 먼저 식별해야 한다. 여기선 부산이 레퍼런스 그룹이다.

## 다중비교와 사후검정

### 예제5

![](./images/4.png)

```{r}
#| label: put data
Mon = c(150, 120, 130, 160, 140)
Tue = c(170, 180, 190, 200, 160)
Wed = c(130, 140, 150, 160, 170)
Thr = c(200, 180, 170, 190, 210)
Fri = c(160, 170, 150, 140, 180)
Sat = c(220, 230, 210, 240, 220)
Sun = c(250, 240, 230, 220, 210)
df1 = data.frame(Mon, Tue, Wed, Thr, Fri ,Sat, Sun)
```

#### 분산분석 및 분산분석표

```{r}
#| label: tidy data로 변경

df2 = stack(df1)
```

```{r}
#| label: 분산분석

M1 = aov(values ~ ind,df2)
anova(M1)
```

F 검정에 의한 p-value가 5% 유의 수준 보다 작기 때문에 요일별 평균값이 동일하다는 귀무가설을 기각한다. 이제 사후검정을 통해 어떤 요일의 평균값이 어떻게 다른지 확인해봐야 한다.

#### 분산분석 모형 모수 확인 - 효과모형 이용

```{r}
model.tables(M1)
```

모수를 봤을 때, 토요일과 일요일에 웹사이트 방문자수가 많다. 이제 다중비교를 통해 통계적 유의성을 확인해보자.

#### 다중비교, 사후검정

##### Tukey HSD

```{r}
#| label: TukeyHSD

TukeyHSD(M1)
```

##### Dunnett

```{r}
#| label: Dunnett 검정

DescTools::DunnettTest(values~ind,df2,control = "Tue") # 레퍼런스 그룹을 화요일로 선택
```

##### Fisher LSD

```{r}
#| label: Fisher LSD 검정
DescTools::PostHocTest(M1, method = "lsd")
```

##### Bonferroni

```{r}
#| label: Bonferroni

DescTools::PostHocTest(M1, method = "bonferroni")
```


## 분산분석 가정에 대한 검토
